# 阵营恢复功能测试

## 测试步骤

### 1. 清除本地存储中的阵营信息
```javascript
// 在小程序开发者工具的控制台中执行
wx.removeStorageSync('userFaction');
console.log('已清除本地阵营信息');
```

### 2. 访问兰亭页面
- 进入 `pages/lanTing/index` 页面
- 观察页面是否显示阵营选择界面还是已选择阵营

### 3. 检查控制台日志
查看是否有以下日志：
- `获取用户阵营信息失败:` - 如果出现此错误，说明云函数调用失败
- 成功的话应该能看到阵营信息被恢复

### 4. 验证本地存储恢复
```javascript
// 在控制台中检查
console.log('恢复后的阵营:', wx.getStorageSync('userFaction'));
```

## 预期结果

### 如果用户之前选择过阵营
1. ✅ 页面应该显示已选择的阵营（不显示选择界面）
2. ✅ 本地存储中应该恢复 `userFaction` 值
3. ✅ 可以正常进入PK页面

### 如果用户从未选择过阵营
1. ✅ 页面显示阵营选择界面
2. ✅ 控制台显示"未找到用户阵营信息"

## 数据库验证

在数据库中查询用户的PK参与记录：
```javascript
// 查询条件
{
  "openid": "用户的微信openid"
}

// 预期结果
{
  "_id": "...",
  "openid": "...",
  "userFaction": "tower", // 或 "rain"
  "date": "2025-07-16",
  "createdAt": "...",
  // ... 其他字段
}
```

## 故障排除

### 问题1：云函数调用失败
- 检查云函数是否正确部署
- 检查网络连接
- 查看云函数日志

### 问题2：数据库查询无结果
- 确认用户确实有PK参与记录
- 检查 openid 是否正确
- 确认数据库权限设置

### 问题3：阵营信息未恢复到本地
- 检查云函数返回的数据格式
- 确认前端代码正确处理返回结果
- 验证 `wx.setStorageSync` 调用是否成功
