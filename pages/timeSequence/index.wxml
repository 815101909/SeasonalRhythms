<!-- æ—¶åºç»çº¬é¡µé¢ -->
<!-- åŠ è½½å±å¹•ç§»é™¤ -->

<!-- å¯»å®å‘ç°å¼¹çª—å·²ç§»é™¤ -->

<!-- çºªå¿µå‹‹ç« å¼¹çª— -->
<view class="child-modal" wx:if="{{showMedalModal}}" catchtap="closeMedal">
  <view class="child-modal-content" catchtap="stopPropagation">
    <view class="child-modal-header medal-header">
      <text>çºªå¿µå‹‹ç« </text>
      <view class="child-close-btn" catchtap="closeMedal">Ã—</view>
    </view>
    <view class="child-modal-body">
      <image wx:if="{{selectedCity.medal && selectedCity.medal.image}}" class="child-modal-image medal-img" src="{{selectedCity.medal.image}}" mode="aspectFit" lazy-load="true"></image>
      <view class="child-modal-desc-box">
        <text>{{(selectedCity.medal && selectedCity.medal.description) || 'æš‚æ— å‹‹ç« '}}</text>
      </view>
      <block wx:if="{{!medalClaimed}}">
        <view class="submit-btn" bindtap="claimMedal">é¢†å–</view>
      </block>
      <block wx:else>
        <view class="submit-btn disabled">å·²é¢†å–</view>
      </block>
    </view>
  </view>
</view>

<!-- ä¼šå‘˜æé†’å¼¹çª— -->
<view class="child-modal" wx:if="{{showMembershipModal}}" catchtap="closeMembershipModal">
  <view class="child-modal-content" catchtap="stopPropagation">
    <view class="child-modal-header medal-header">
      <text>ä¼šå‘˜æé†’</text>
      <view class="child-close-btn" catchtap="closeMembershipModal">Ã—</view>
    </view>
    <view class="child-modal-body">
      <view class="child-modal-desc-box">
        <text>è§†é¢‘è¯•çœ‹å·²ç»“æŸï¼Œå¼€é€šä¼šå‘˜åå¯è§‚çœ‹å®Œæ•´è§†é¢‘</text>
      </view>
      <view class="submit-btn" bindtap="goToMembership">ç«‹å³å¼€é€š</view>
      <view class="submit-btn" bindtap="closeMembershipModal">ç¨åå†è¯´</view>
    </view>
  </view>
</view>

<view class="time-sequence-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-title">
    <text>ä¸€æ—¥ä¸€åŸãƒ»æ—¶èŠ‚æ¼«æ¸¸</text>
  </view>

  <!-- ç¾æ™¯è½®æ’­å›¾ -->
  <view class="scenic-banner">
    <swiper autoplay="{{true}}" 
            interval="3000" 
            circular="{{true}}" 
            class="scenic-swiper"
            bindchange="onSwiperChange"
            current="{{currentSwiperIndex}}">
      <swiper-item wx:for="{{scenicImages}}" wx:key="index">
        <image src="{{item.localUrl || item.imgUrl}}" mode="aspectFill" class="scenic-image" lazy-load="true" />
        <view class="scenic-caption">{{item.caption}}</view>
      </swiper-item>
    </swiper>
    <!-- è‡ªå®šä¹‰æŒ‡ç¤ºç‚¹ -->
    <view class="scenic-indicator">
      <view class="indicator-dot {{currentSwiperIndex === index ? 'active' : ''}}" 
            wx:for="{{scenicImages}}" 
            wx:key="index">
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="nav-header">
    <view class="nav-item year-selector">
      <picker bindchange="onYearChange" value="{{yearIndex}}" range="{{years}}">
        <view class="selector-trigger">
          <text class="selector-text">{{currentYear}}å¹´</text>
          <text class="dropdown-icon">â–¼</text>
          <!-- å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å›¾ç‰‡ä½œä¸ºä¸‹æ‹‰ç®­å¤´ -->
          <!-- <image class="dropdown-arrow-img" src="/images/down-arrow.png" mode="aspectFit" wx:if="{{false}}"></image> -->
        </view>
      </picker>
    </view>

    <!-- æœˆä»½é€‰æ‹©å™¨ -->
    <view class="nav-item month-selector">
      <picker bindchange="onMonthChange" value="{{monthIndex}}" range="{{monthNames}}">
        <view class="selector-trigger">
          <text class="selector-text">{{currentMonthName}}</text>
          <text class="dropdown-icon">â–¼</text>
          <!-- å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å›¾ç‰‡ä½œä¸ºä¸‹æ‹‰ç®­å¤´ -->
          <!-- <image class="dropdown-arrow-img" src="/images/down-arrow.png" mode="aspectFit" wx:if="{{false}}"></image> -->
        </view>
      </picker>
    </view>
    
    <!-- æ ‘æœ¨æˆå°±æ˜¾ç¤º -->
    <view class="nav-item tree-info">
      <view class="selector-trigger tree-counter">
        <text class="tree-icon">ğŸŒ³</text>
        <text class="selector-text">{{timeSequenceTrees}}é¢—</text>
      </view>
    </view>
  </view>

  <!-- åŸå¸‚å±•ç¤ºåŒºåŸŸ -->
  <view class="cities-container">
    <view class="cities-grid" wx:if="{{displayedCities.length > 0}}">
      <block wx:for="{{displayedCities}}" wx:key="id">
        <view class="city-card {{item.unlocked ? 'unlocked' : 'locked'}} {{item.season}}" 
              bindtap="onCityTap" 
              data-city="{{item}}"
              style="background-color: {{item.seasonBgColor}};">
          <text class="season-emoji">{{item.seasonEmoji}}</text>
          <!-- å·²è§£é”åŸå¸‚ -->
          <block wx:if="{{item.unlocked}}">
            <view class="city-icon">
              <!-- é¢„ç•™åŸå¸‚å°é¢APIæ¥å£ -->
              <image class="city-image" src="{{item.iconUrl}}" mode="aspectFill" wx:if="{{item.iconUrl}}" lazy-load="true"></image>
              <view class="city-icon-placeholder" wx:else></view>
            </view>
            <!-- é¢„ç•™åŸå¸‚åç§°APIæ¥å£ -->
            <view class="city-name">{{item.name}}</view>
            <!-- ç³»ç»Ÿç”Ÿæˆçš„æ—¥æœŸ -->
            <view class="unlock-date">{{item.unlockDate}}</view>
          </block>
          
          <!-- æœªè§£é”åŸå¸‚ -->
          <block wx:else>
            <view class="city-locked">
              <text class="lock-emoji">ğŸ”’</text>
              <text class="unlock-countdown">{{item.daysToUnlock === 0 ? 'ä»Šå¤©è§£é”' : (item.daysToUnlock + 'å¤©åè§£é”')}}</text>
            </view>
          </block>
        </view>
      </block>
    </view>
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ™ï¸</view>
      <view class="empty-text">{{currentYear}}å¹´{{currentMonth}}æœˆæš‚æ— åŸå¸‚æ•°æ®</view>
    </view>
  </view>

  <!-- åˆ†é¡µå¯¼èˆªåŒºåŸŸ - ä»…åœ¨ä¸»é¡µé¢æ˜¾ç¤ºï¼Œä¸åœ¨åŸå¸‚è¯¦æƒ…é¡µæ˜¾ç¤º -->
  <view class="pagination-container" wx:if="{{!showCityDetail}}">
    <!-- é¡µé¢å¯¼èˆª -->
    <view class="pagination">
      <view class="page-btn prev {{currentPage === 1 ? 'disabled' : ''}}" bindtap="onPrevPage">â†</view>
      <!-- é¡µç æ˜¾ç¤ºï¼ˆå±…ä¸­ï¼‰ -->
      <view class="page-display">
        <text class="page-text">ç¬¬{{currentPage}}/{{totalPages}}é¡µ</text>
      </view>
      <view class="page-btn next {{currentPage === totalPages ? 'disabled' : ''}}" bindtap="onNextPage">â†’</view>
    </view>
  </view>

  <!-- åŸå¸‚è¯¦æƒ…é¡µé¢ -->
  <view class="city-detail-page" wx:if="{{showCityDetail}}" style="{{fontSizeStyle}}" catchtouchmove="preventScroll">
    <view class="edge-swipe-area {{edgeSwipeEnabled ? '' : 'edge-swipe-disabled'}}" catchtouchstart="onEdgeTouchStart" catchtouchmove="onEdgeTouchMove" catchtouchend="onEdgeTouchEnd"></view>
    <view class="city-detail-content">
      
      <!-- å°é¢å’Œè§†é¢‘å¹¶æ’æ˜¾ç¤ºå®¹å™¨ - åªåœ¨åŸå¸‚è¯¦æƒ…æ¨¡å¼æ˜¾ç¤º -->
      <view class="media-container" wx:if="{{!showCityMuseum && showMediaContainer}}">
        <view class="city-detail-header">
          <!-- å°é¢å›¾ç‰‡ -->
          <image class="city-icon-large" src="{{selectedCity.iconUrl}}" mode="aspectFill" wx:if="{{selectedCity.iconUrl}}" lazy-load="true"></image>
          <view class="city-icon-large" wx:else></view>
          
          <!-- åŸå¸‚åç§°å’Œå›½å®¶æ˜¾ç¤ºåŒºï¼Œå‹åœ¨åº•éƒ¨ -->
          <view class="city-title" style="position:absolute; bottom:0; left:0; right:0; background-color:rgba(255, 240, 245, 0.8); z-index:50; display:flex; justify-content:space-between; padding:12rpx 20rpx;">
            <text class="city-name-large">{{selectedCity.name || 'åŸå¸‚å¾…å‘½å'}}</text>
            <text class="city-country">{{selectedCity.country || 'ä¸­å›½'}}</text>
          </view>
        </view>
        
        <view class="video-container">
          <image 
            class="city-video" 
            src="{{selectedCity.basicImageUrl}}" 
            wx:if="{{selectedCity.basicImageUrl}}"
            mode="aspectFill"
            lazy-load="true"
          ></image>
          <view class="city-video" wx:else></view>
          <view class="video-title">
            <text class="video-city-name">{{selectedCity.nameEn || 'City Name'}}</text>
            <text class="video-date">{{selectedCity.unlockYear || '2023'}}å¹´{{selectedCity.unlockDate || '05-15'}}</text>
          </view>
        </view>
      </view>
      
      <!-- åšç‰©é¦†é¡µé¢æ ‡é¢˜ - åªåœ¨åšç‰©é¦†æ¨¡å¼æ˜¾ç¤º -->
      <view class="museum-header" wx:if="{{showCityMuseum}}">
        <view class="museum-title">
          <text class="museum-title-text">åŸå¸‚åšç‰©é¦†</text>
          <text class="museum-subtitle">City Museum</text>
        </view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’®åŒºï¼Œç§»è‡³æ»šåŠ¨åŒºåŸŸä¸Šæ–¹ -->
      <view class="unified-actions">
        <!-- <view class="action-btn" bindtap="disabledBackTap"><text class="btn-icon">â®</text></view> -->
        
        <!-- åœ°æ ‡æ‰“å¡åŒº - åªåœ¨åŸå¸‚è¯¦æƒ…æ¨¡å¼æ˜¾ç¤º -->
        <view class="landmarks-horizontal-container" wx:if="{{!showCityMuseum}}">
          <view class="landmarks-journey">
            <!-- å·¦ä¾§æ ‡é¢˜åŒº -->
            <view class="title-section">
            <view class="back-btn" bindtap="disabledBackTap">
              <text class="btn-icon">â®</text>
              <text class="btn-text">è¿”å›</text>
            </view>
              <view class="title-emoji">ğŸ“</view>
              <view class="title-text">åœ°æ ‡æ‰“å¡</view>
            </view>
            
            <!-- å³ä¾§åœ°æ ‡è·¯å¾„ -->
            <view class="landmarks-path">
              <block wx:for="{{cityLandmarks}}" wx:key="id" wx:for-index="idx">
                <!-- åœ°æ ‡å›¾æ ‡ -->
                <view 
                  class="landmark-node {{item.lit ? 'lit' : ''}} landmark-wave-{{idx}}"
                  bindtap="onLandmarkTap"
                  data-index="{{idx}}">
                  <view class="landmark-emoji">{{item.emoji}}</view>
                  <view class="landmark-glow" wx:if="{{item.lit}}"></view>
                  <view class="landmark-pulse"></view>
                  <view class="landmark-name">{{item.name}}</view>
                </view>
                
                <!-- ç®­å¤´è¿æ¥çº¿ï¼ˆæœ€åä¸€ä¸ªä¸æ˜¾ç¤ºï¼‰ -->
                <view class="landmark-arrow {{item.lit ? 'lit' : ''}}" wx:if="{{idx < cityLandmarks.length - 1}}">
                  <view class="arrow-line"></view>
                </view>
              </block>
            </view>
          </view>
        </view>
      </view>

      <scroll-view scroll-y="{{false}}" class="city-info-scroll" enhanced="true" show-scrollbar="{{false}}" bounces="false" bindscroll="onContentScroll" scroll-top="{{scrollTop}}" style="{{fontSizeStyle}}">
        
        <!-- æ–°çš„è§†é¢‘åŒºåŸŸ -->
        <view class="video-gallery-section">
          <view class="video-card-container">
            <!-- è£…é¥°æ€§æ³¢æµªèƒŒæ™¯ - å¤šå±‚åŠ¨æ€æ³¢æµª -->
          <view class="waves-container">
            <view class="wave wave-bg"></view>
            <view class="wave wave-mid"></view>
            <!-- å°èˆ¹å›¾æ ‡ - ç§»å…¥æ³¢æµªä¸­é—´å±‚å®ç°æ²‰æµ¸æ„Ÿ -->
            <view class="boat-wrapper">
              <image src="/images/icons/å°èˆ¹1.png" mode="aspectFit" class="boat-icon" lazy-load="true"></image>
            </view>
            <view class="wave wave-fg"></view>
          </view>
          
          <!-- ä¸»è§†é¢‘å¡ç‰‡ -->
            <view class="video-card-main">
              <video 
                id="galleryVideo"
                src="{{selectedCity.videoUrl}}" 
                class="gallery-video"
                object-fit="cover"
                show-center-play-btn="{{true}}"
                show-play-btn="{{true}}"
                controls="{{true}}"
                enable-progress-gesture="{{isVIP}}"
                show-progress="{{true}}"
                title="{{selectedCity.name}} åŸå¸‚æ˜ åƒ"
                bindplay="onVideoPlay"
                bindpause="onVideoPause"
                bindended="onVideoEnded"
                bindtimeupdate="onVideoTimeUpdate"
                bindwaiting="onVideoWaiting"
                bindfullscreenchange="onVideoFullscreenChange"
              >
                <cover-view wx:if="{{!videoPlaying}}" class="double-tap-overlay" bindtap="onVideoTap"></cover-view>
                <cover-view 
                  wx:if="{{!isVIP}}" 
                  class="progress-blocker" 
                  catchtap="stopPropagation" 
                  catchtouchstart="stopPropagation" 
                  catchtouchmove="stopPropagation"
                ></cover-view>
              </video>
              
              <!-- è§†é¢‘ä¿¡æ¯æ¡ -->
              <view class="gallery-video-info">
                <!-- èƒŒæ™¯è£…é¥°æ°´å° -->
                <view class="bg-watermark">TRAVEL</view>
                
                <view class="info-top">
                  <text class="gallery-city-name">{{selectedCity.name}}</text>
                  <view class="gallery-en-name">{{selectedCity.nameEn || 'City of Light'}}</view>
                  <view class="info-divider"></view>
                  <text class="gallery-slogan">DISCOVER</text>
                  <view class="gallery-coords">
                    <text>41Â°17'S</text>
                    <text class="coord-dot">Â·</text>
                    <text>174Â°46'E</text>
                  </view>
                </view>
                
                <!-- ä¸­é—´è£…é¥°æ ‡ç­¾ -->
                <view class="info-middle-deco">
                   <view class="tech-tag">HD</view>
                   <view class="tech-dot">â—</view>
                   <view class="tech-tag">VLOG</view>
                </view>
                
                <view class="info-bottom">
                  <view class="play-indicator">
                    <view class="bar bar1"></view>
                    <view class="bar bar2"></view>
                    <view class="bar bar3"></view>
                  </view>
                  <text class="gallery-date">{{selectedCity.unlockYear || '2026'}}.{{selectedCity.unlockDate ? selectedCity.unlockDate.split('-')[0] : '2'}}</text>
                </view>
              </view>
            </view>
            
            <!-- è§†é¢‘ä¸‹æ–¹æ“ä½œç½‘æ ¼ -->
            <view class="action-grid-container">
              <view class="action-grid-item" bindtap="openChallenge">
                <view class="action-icon">
                  <view class="css-icon-challenge"></view>
                </view>
                <text class="action-text">å¼€å§‹æŒ‘æˆ˜</text>
              </view>
              <!-- å¯»å®å‘ç°æŒ‰é’®å·²ç§»é™¤ -->
              <view class="action-grid-item" bindtap="openMedal">
                <view class="action-icon">
                  <view class="css-icon-medal"></view>
                </view>
                <text class="action-text">çºªå¿µå‹‹ç« </text>
              </view>
              <view class="action-grid-item" bindtap="leaveFootprint">
                <view class="action-icon">
                  <text style="font-size: 36rpx;">ğŸ‘£</text>
                </view>
                <text class="action-text">ç•™ä¸‹è¶³è¿¹</text>
              </view>
            </view>
            
            <!-- åº•éƒ¨çµæ„Ÿå¡ç‰‡ -->
            <view class="inspiration-card">
              <view class="inspiration-header">
                <text class="inspiration-title">æ—…è¡ŒÂ·å¯„è¯­</text>
                <text class="inspiration-date">TODAY</text>
              </view>
              <view class="inspiration-content">
                <text class="quote-text">â€œ{{selectedCity.description || 'è¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ï¼Œç¾å¥½çš„é£æ™¯å°±åœ¨è„šä¸‹ã€‚'}}â€</text>
              </view>
              <view class="inspiration-bg-icon">âœˆï¸</view>
            </view>
          </view>
        </view>

        <!-- åº•éƒ¨é¢å¤–ç©ºé—´ -->
        <view class="scroll-bottom-space"></view>
        
      </scroll-view>
    </view>
  </view>
  
  <!-- åœ°æ ‡è¯¦æƒ…å¼¹çª— -->
  <view class="landmark-modal" wx:if="{{showLandmarkModal}}" catchtap="closeLandmarkModal">
    <view class="landmark-modal-content {{currentLandmark.lit ? 'lit' : ''}}" catchtap="stopPropagation">
      <!-- å¤ç¯èƒŒæ™¯å®¹å™¨ -->
      <view class="ancient-lantern-bg {{currentLandmark.lit ? 'lit' : ''}}">
        <!-- ç¯ç¬¼ä¸»ä½“ -->
        <view class="lantern-body">
          <!-- åœ°æ ‡å›¾ç‰‡èƒŒæ™¯ -->
          <view class="lantern-image" style="background-image: url('{{currentLandmark.image}}')"></view>
          <!-- ç¯ç¬¼å‘å…‰å±‚ -->
          <view class="lantern-glow"></view>
        </view>
        <!-- ç¯ç¬¼é¡¶éƒ¨ -->
        <view class="lantern-top"></view>
        <!-- ç¯ç¬¼åº•éƒ¨ -->
        <view class="lantern-bottom"></view>
        <!-- ç¯ç©— -->
        <view class="lantern-tassel"></view>
      </view>
      
      <view class="landmark-modal-info">
        <view class="landmark-modal-title">{{currentLandmark.name}}</view>
        <view class="landmark-modal-desc">{{currentLandmark.description}}</view>
      </view>
      
      <view class="landmark-light-btn {{currentLandmark.lit ? 'lit' : ''}}" catchtap="lightUpLandmark">
        <text class="light-btn-text">{{currentLandmark.lit ? 'å·²ç‚¹äº®' : 'ç‚¹äº®'}}</text>
      </view>
      
      <view class="landmark-close-btn" catchtap="closeLandmarkModal">Ã—</view>
    </view>
  </view>
</view>

<!-- æŒ‘æˆ˜å¼¹çª— -->
<view class="challenge-modal" wx:if="{{showChallenge}}" style="z-index:9999;">
  <view class="challenge-content">
    <view class="challenge-header">
      <view class="challenge-title">åŸå¸‚çŸ¥è¯†æŒ‘æˆ˜</view>
      <view class="challenge-subtitle">
        <block wx:if="{{isFirstAttempt}}">ç­”å¯¹é¢˜ç›®å¯è·å¾—å°æ ‘å¥–åŠ±ï¼</block>
        <block wx:else><text class="repeated-challenge">é‡å¤æŒ‘æˆ˜ä¸å†è·å¾—å°æ ‘å¥–åŠ±</text></block>
      </view>
      <view class="challenge-close" bindtap="closeChallenge">Ã—</view>
    </view>
    
    <view class="challenge-body">
      <!-- å•é€‰é¢˜ -->
      <view class="challenge-step" wx:if="{{challengeStep === 1}}">
        <view class="challenge-question">{{singleQuestion.question}}</view>
        <view class="challenge-options">
          <view 
            class="option-item {{singleQuestion.selectedOption === index ? 'selected' : ''}} {{singleQuestion.showResult ? (index === singleQuestion.correctOption ? 'correct' : (singleQuestion.selectedOption === index ? 'incorrect' : '')) : ''}}" 
            wx:for="{{singleQuestion.options}}" 
            wx:key="index" 
            bindtap="{{singleQuestion.showResult ? '' : 'selectSingleOption'}}" 
            data-index="{{index}}"
          >
            <view class="option-checkbox {{singleQuestion.selectedOption === index ? 'selected' : ''}} {{singleQuestion.showResult ? (index === singleQuestion.correctOption ? 'correct' : (singleQuestion.selectedOption === index ? 'incorrect' : '')) : ''}}">
              <block wx:if="{{singleQuestion.selectedOption === index}}">âœ“</block>
              <block wx:elif="{{singleQuestion.showResult && index === singleQuestion.correctOption}}">âœ“</block>
              <block wx:elif="{{singleQuestion.showResult && singleQuestion.selectedOption === index}}">âœ—</block>
            </view>
            <view class="option-text">{{item}}</view>
          </view>
        </view>
        <view class="feedback-message" wx:if="{{singleQuestion.showResult}}">
          <text class="{{singleQuestion.isCorrect ? 'success-text' : 'error-text'}}">{{singleQuestion.isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}}</text>
        </view>
      </view>
      
      <!-- æ‹¼å›¾æŒ‘æˆ˜ -->
      <view class="challenge-step" wx:if="{{challengeStep === 2}}">
        <view class="puzzle-container">
          <view class="puzzle-header">
            <text class="puzzle-title">å›¾ç‰‡æ‹¼å›¾</text>
            <text class="puzzle-instruction">å°†æ‹¼å›¾ç¢ç‰‡æ”¾åˆ°æ­£ç¡®çš„ä½ç½®</text>
          </view>
          
          <!-- æ‹¼å›¾æ¿ - æ§½ä½åŒºåŸŸ -->
          <view class="puzzle-slots-area">
            <view 
              wx:for="{{puzzleSlots}}" 
              wx:key="index" 
              class="puzzle-slot {{item.filled ? 'filled' : ''}}"
              bindtap="onPuzzleSlotTap"
              data-index="{{item.index}}">
              <text class="slot-number" wx:if="{{!item.filled && showPuzzleNumbers}}">{{item.index + 1}}</text>
              <view class="puzzle-slot-content" wx:if="{{item.filled}}">
                <view 
                  class="puzzle-piece-in-slot"
                  style="background-image: url('{{puzzleImageUrl}}'); background-position: {{item.col * -100}}px {{item.row * -100}}px; background-size: 300px 300px;">
                </view>
              </view>
            </view>
          </view>
          
          <!-- æ‹¼å›¾ç¢ç‰‡åŒºåŸŸ -->
          <view class="puzzle-pieces-area">
            <view 
              wx:for="{{puzzlePieces}}" 
              wx:key="index"
              class="puzzle-piece {{selectedPieceIndex === index ? 'selected' : ''}} {{item.placed ? 'placed' : ''}}"
              catch:tap="onPuzzlePieceTap"
              data-index="{{index}}"
              wx:if="{{!item.placed}}">
              <view 
                class="puzzle-piece-content"
                style="background-image: url('{{puzzleImageUrl}}'); background-position: {{item.backgroundPositionX}}px {{item.backgroundPositionY}}px; background-size: 300px 300px;">
              </view>
              <text class="piece-number" wx:if="{{showPuzzleNumbers}}">{{item.id + 1}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æŒ‘æˆ˜ç»“æœ -->
      <view class="challenge-step" wx:if="{{challengeStep === 3}}">
        <view class="result-container">
          <!-- æˆåŠŸè·å¾—å°æ ‘æƒ…å†µ -->
          <block wx:if="{{earnedTrees > 0}}">
            <view class="success-emoji">ğŸŒ³</view>
            <view class="result-title success">æŒ‘æˆ˜æˆåŠŸ</view>
            <view class="result-message success">æ­å–œè·å¾—äº†å°æ ‘å¥–åŠ±ï¼</view>
            <view class="tree-count-container">
              <view class="tree-count">
                <text class="tree-emoji">ğŸŒ³</text>
                <text class="tree-number">{{earnedTrees}}</text>
                <text class="tree-unit">é¢—</text>
              </view>
            </view>
          </block>
          
          <!-- æœªè·å¾—å°æ ‘æƒ…å†µ -->
          <block wx:else>
            <view class="{{isFirstAttempt ? 'encourage-emoji' : 'neutral-emoji'}}">
              {{isFirstAttempt ? 'ğŸ’ª' : 'ğŸŒ±'}}
            </view>
            <view class="result-title {{isFirstAttempt ? 'encourage' : 'neutral'}}">
              {{isFirstAttempt ? 'ä¸è¦æ°”é¦' : 'é‡å¤æŒ‘æˆ˜'}}
            </view>
            <view class="result-message {{isFirstAttempt ? 'encourage' : 'neutral'}}">
              {{isFirstAttempt ? 'ç»§ç»­åŠªåŠ›ï¼Œç›¸ä¿¡ä¸‹æ¬¡ä¸€å®šèƒ½æˆåŠŸï¼' : 'é‡å¤æŒ‘æˆ˜æ— æ³•è·å¾—å°æ ‘å¥–åŠ±ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚~'}}
            </view>
            <view class="result-tips" wx:if="{{isFirstAttempt}}">
              <text>æç¤ºï¼šè®¤çœŸé˜…è¯»åŸå¸‚æè¿°å¯ä»¥å¸®åŠ©è§£ç­”é—®é¢˜å“¦</text>
            </view>
          </block>
        </view>
      </view>
    </view>
    <view class="challenge-footer">
      <view 
        class="submit-btn {{(challengeStep === 1 && singleQuestion.selectedOption === null && !singleQuestion.showResult) ? 'disabled' : ''}} {{(challengeStep === 1 && singleQuestion.showResult) || challengeStep >= 2 ? 'submit-btn-answered' : ''}}" 
        bindtap="{{(challengeStep === 1 && !singleQuestion.showResult) ? 'submitSingleAnswer' : 'nextChallengeStep'}}"
        data-index="{{singleQuestion.selectedOption}}"
      >
        <text wx:if="{{challengeStep === 1 && !singleQuestion.showResult}}">æäº¤ç­”æ¡ˆ</text>
        <text wx:elif="{{challengeStep === 1 && singleQuestion.showResult}}">ä¸‹ä¸€é¢˜</text>
        <text wx:elif="{{challengeStep === 2}}">{{puzzleComplete ? 'å®ŒæˆæŒ‘æˆ˜' : 'æäº¤ç­”æ¡ˆ'}}</text>
        <text wx:else>å®Œæˆ</text>
      </view>
    </view>
  </view>
</view>

<!-- ç»“æœå¼¹çª— -->
<view class="result-modal" wx:if="{{showResult}}">
  <view class="result-content">
    <!-- æˆåŠŸè·å¾—å°æ ‘æƒ…å†µ -->
    <block wx:if="{{earnedTrees > 0}}">
      <view class="result-emoji-container">
        <view class="result-emoji success-emoji">ğŸŒ³</view>
        <view class="result-emoji-sparkle"></view>
      </view>
      <view class="result-title success">æŒ‘æˆ˜æˆåŠŸ</view>
      <view class="result-message success">æ­å–œè·å¾—äº†å°æ ‘å¥–åŠ±ï¼</view>
      <view class="result-detail">
        <view class="tree-count-container">
          <view class="tree-count">
            <text class="tree-emoji">ğŸŒ³</text>
            <text class="tree-number">{{earnedTrees}}</text>
            <text class="tree-unit">é¢—</text>
          </view>
          <view class="tree-shadow"></view>
        </view>
      </view>
    </block>
    
    <!-- æœªè·å¾—å°æ ‘æƒ…å†µ -->
    <block wx:else>
      <view class="result-emoji-container">
        <view class="result-emoji {{isFirstAttempt ? 'encourage-emoji' : 'neutral-emoji'}}">
          {{isFirstAttempt ? 'ğŸ’ª' : 'ğŸŒ±'}}
        </view>
      </view>
      <view class="result-title {{isFirstAttempt ? 'encourage' : 'neutral'}}">
        {{isFirstAttempt ? 'ä¸è¦æ°”é¦' : 'é‡å¤æŒ‘æˆ˜'}}
      </view>
      <view class="result-message {{isFirstAttempt ? 'encourage' : 'neutral'}}">
        {{isFirstAttempt ? 'ç­”å¯¹é¢˜ç›®æ‰èƒ½è·å¾—å°æ ‘å¥–åŠ±ï¼Œå†æ¥å†å‰å“¦ï¼' : 'é‡å¤æŒ‘æˆ˜æ— æ³•è·å¾—å°æ ‘å¥–åŠ±ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚~'}}
      </view>
      <view class="result-tips" wx:if="{{isFirstAttempt}}">
        <text>æç¤ºï¼šå°è¯•è®¤çœŸé˜…è¯»åŸå¸‚æè¿°ï¼Œä¼šæœ‰æ‰€å¸®åŠ©</text>
      </view>
    </block>
    
    <view class="result-footer">
      <view class="result-btn" bindtap="closeResult">çŸ¥é“äº†</view>
    </view>
  </view>
</view>

<!-- æ‰“å°é¢„è§ˆå¼¹çª— -->
<view class="print-page-container" wx:if="{{showPrintPreview}}">
  <view class="print-page-header">
    <view class="print-page-title">æ‰“å°é¢„è§ˆ</view>
    <view class="print-page-actions">
      <view class="print-action-btn cancel" bindtap="closePrintPreview">è¿”å›</view>
    </view>
  </view>
  
  <view class="print-pages-tabs">
    <view class="print-tab {{activePrintTab === 'graphic' ? 'active' : ''}}" bindtap="switchPrintTab" data-tab="graphic">å›¾æ–‡ç‰ˆ</view>
    <view class="print-tab {{activePrintTab === 'text' ? 'active' : ''}}" bindtap="switchPrintTab" data-tab="text">æ–‡å­—ç‰ˆ</view>
  </view>

  <!-- A4é¢„è§ˆé¡µé¢åŒºåŸŸ -->
  <view class="print-page-content">
    <!-- å›¾æ–‡ç‰ˆA4é¢„è§ˆ -->
    <view class="a4-preview" wx:if="{{activePrintTab === 'graphic'}}">
      <!-- æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤ºå›¾ç‰‡ -->
      <block wx:if="{{a4Pages.richTextContent && a4Pages.richTextContent.length > 0}}">
        <swiper class="a4-swiper" indicator-dots="{{true}}" autoplay="{{false}}">
          <swiper-item wx:for="{{a4Pages.richTextContent}}" wx:key="index">
            <image src="{{item}}" mode="aspectFit" class="a4-image" data-url="{{item}}" bindtap="previewImage" data-urls="{{a4Pages.richTextContent}}" data-current="{{item}}" lazy-load="true"/>
          </swiper-item>
        </swiper>
      </block>
      <!-- æ— å›¾ç‰‡æ—¶æ˜¾ç¤ºå ä½ -->
      <view class="a4-placeholder" wx:else>
        <view class="a4-info">é¢„ç•™å›¾æ–‡ç‰ˆA4æ‰“å°åŒºåŸŸ</view>
        <view class="a4-api-note">è¿æ¥æ‰“å°APIç«¯å£</view>
      </view>
    </view>
    
    <!-- æ–‡å­—ç‰ˆ A4é¢„è§ˆ -->
    <view class="a4-preview" wx:if="{{activePrintTab === 'text'}}">
      <!-- æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤ºå›¾ç‰‡ -->
      <block wx:if="{{a4Pages.plainTextContent1 && a4Pages.plainTextContent1.length > 0}}">
        <swiper class="a4-swiper" indicator-dots="{{true}}" autoplay="{{false}}">
          <swiper-item wx:for="{{a4Pages.plainTextContent1}}" wx:key="index">
            <image src="{{item}}" mode="aspectFit" class="a4-image" data-url="{{item}}" bindtap="previewImage" data-urls="{{a4Pages.plainTextContent1}}" data-current="{{item}}" lazy-load="true"/>
          </swiper-item>
        </swiper>
      </block>
      <!-- æ— å›¾ç‰‡æ—¶æ˜¾ç¤ºå ä½ -->
      <view class="a4-placeholder" wx:else>
        <view class="a4-info">é¢„ç•™æ–‡å­—ç‰ˆA4æ‰“å°åŒºåŸŸ</view>
        <view class="a4-api-note">è¿æ¥æ‰“å°APIç«¯å£</view>
      </view>
    </view>
  </view>
</view>
